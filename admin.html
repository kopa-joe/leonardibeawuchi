<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scholarship Admin Dashboard</title>
    <link rel="icon" type="image/png" href="img/logo.png">
    <link rel="apple-touch-icon" href="img/logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        if (sessionStorage.getItem('isAdmin') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <style>
        :root { --primary: #0b1f3a; --accent: #c9a227; --success: #27ae60; --disabled: #e9ecef; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .name-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .score-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        input:disabled, select:disabled { background-color: var(--disabled); cursor: not-allowed; }
        label { display: block; margin-top: 10px; font-weight: bold; color: #555; font-size: 0.85rem; }
        .required-star { color: #e74c3c; margin-left: 2px; }
        .lock-icon { margin-left: 5px; color: #7f8c8d; font-size: 0.8rem; display: none; }
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .save-btn { background: var(--success); color: white; border: none; padding: 15px; flex: 2; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .cancel-btn { background: #95a5a6; color: white; border: none; padding: 15px; flex: 1; border-radius: 6px; cursor: pointer; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .link-btn { background: #eee; border: 1px solid #ccc; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .qr-btn { background: var(--accent); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 5px; }
        .edit-btn { background: #3498db; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
        .del-btn { background: #e74c3c; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
        #qr-buffer { position: absolute; left: -9999px; top: -9999px; }
    </style>
</head>
<body>
    <div id="qr-buffer"></div>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 id="formTitle">Add New Recipient</h2>
            <button onclick="logout()" style="background:none; border:1px solid #ccc; padding:5px 10px; cursor:pointer; border-radius:4px;">Logout</button>
        </div>

        <form id="studentForm">
            <input type="hidden" id="editId">
            <div class="name-grid">
                <div><label>First Name<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label><input type="text" id="fName" required placeholder="John"></div>
                <div><label>Surname<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label><input type="text" id="lName" required placeholder="Doe"></div>
                <div><label>Other Names<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label><input type="text" id="oName" required placeholder="Michael"></div>
            </div>

            <div class="form-grid">
                <div>
                    <label>Class<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
                    <select id="class" required>
                        <option value="">Select Class</option>
                        <option value="SS1">SS1</option><option value="SS2">SS2</option><option value="SS3">SS3</option>
                    </select>
                </div>
                <div>
                    <label id="yearLabel">Year<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
                    <input type="number" id="year" max="2035" oninput="if(this.value.length > 4) this.value = this.value.slice(0, 4);" required>
                </div>
            </div>

            <label>Position<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
            <select id="pos" required>
                <option value="" selected disabled>Select Position</option>
                <option value="1st Position">1st Position</option><option value="2nd Position">2nd Position</option><option value="3rd Position">3rd Position</option>
            </select>

            <label>Subject Scores (%)<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
            <div class="score-grid">
                <div><label>Maths (25%)</label><input type="number" id="s_math" min="0" max="100" placeholder="0" required></div>
                <div><label>Phys (25%)</label><input type="number" id="s_phys" min="0" max="100" placeholder="0" required></div>
                <div><label>Chem (25%)</label><input type="number" id="s_chem" min="0" max="100" placeholder="0" required></div>
                <div><label>Bio (15%)</label><input type="number" id="s_bio" min="0" max="100" placeholder="0" required></div>
                <div><label>Eng (10%)</label><input type="number" id="s_eng" min="0" max="100" placeholder="0" required></div>
            </div>

            <label>Passport Photo<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
            <input type="file" id="photoFile" accept="image/*">
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            <label>Celebration Photo (Optional)</label>
            <input type="file" id="celebFile" accept="image/*">
            <label>Vote of Thanks</label>
            <textarea id="thanks" rows="4"></textarea>

            <div class="btn-row">
                <button type="submit" id="submitBtn" class="save-btn">SAVE RECIPIENT</button>
                <button type="button" id="cancelBtn" class="cancel-btn" onclick="resetForm()">CANCEL EDIT</button>
            </div>
        </form>

        <table>
            <thead><tr><th>Link & Name</th><th>Year</th><th>Actions</th></tr></thead>
            <tbody id="list"></tbody>
        </table>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        const startY = new Date().getFullYear() - 1, maxY = 2035;
        let allStudents = [], lockedPhotoPath = "";
        
        $('year').min = startY; $('year').value = startY;
        $('yearLabel').innerHTML = `Year (${startY}-${maxY})<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span>`;

        const logout = () => { sessionStorage.removeItem('isAdmin'); window.location.href = 'login.html'; };

        async function fetchList() {
            const res = await fetch('/data/data.json');
            allStudents = await res.json();
            $('list').innerHTML = allStudents.map(s => `
                <tr>
                    <td>
                        <button class="link-btn" onclick="copyLink('${s.id}')">Copy Direct Link ðŸ”—</button>
                        <button class="qr-btn" onclick="generateAndDownloadQR('${s.id}')">Download QR Code ðŸ“¥</button><br>
                        <strong>${s.lName}, ${s.fName} ${s.oName}</strong>
                    </td>
                    <td>${s.year}</td>
                    <td>
                        <button class="edit-btn" onclick="editRecord('${s.id}')">Edit</button>
                        <button class="del-btn" onclick="remove('${s.id}')">Delete</button>
                    </td>
                </tr>`).join('');
        }

        async function generateAndDownloadQR(id) {
            const s = allStudents.find(x => x.id === id);
            if (!s) return;
            const buf = $('qr-buffer'); buf.innerHTML = "";
            new QRCode(buf, { text: window.location.origin + '/index.html?id=' + id, width: 256, height: 256, colorDark: "#c9a227", colorLight: "rgba(0,0,0,0)", correctLevel: QRCode.CorrectLevel.H });
            setTimeout(() => {
                const cv = document.createElement('canvas'), ctx = cv.getContext('2d'), qr = buf.querySelector('canvas');
                cv.width = 300; cv.height = 400;
                ctx.strokeStyle = "#c9a227"; ctx.lineWidth = 5; ctx.strokeRect(5, 5, 290, 390);
                ctx.drawImage(qr, 22, 30, 256, 256);
                ctx.fillStyle = "#c9a227"; ctx.textAlign = "center"; ctx.font = "bold 16px Segoe UI";
                ctx.fillText(`${s.fName} ${s.oName} ${s.lName}`.toUpperCase(), 150, 320);
                ctx.font = "14px Segoe UI"; ctx.fillText("Scan to verify recipient details", 150, 350);
                const a = document.createElement('a');
                a.download = `${s.fName}_${s.oName}_${s.lName}_${s.year}_scholarship_qrcode.png`;
                a.href = cv.toDataURL("image/png"); a.click();
            }, 100);
        }

        const copyLink = id => { navigator.clipboard.writeText(window.location.origin + '/index.html?id=' + id); alert("Full link copied!"); };

        async function uploadFile(input) {
            if (!input.files[0]) return null;
            const fd = new FormData(); fd.append('image', input.files[0]);
            const res = await fetch('/upload', { method: 'POST', body: fd });
            return (await res.json()).filePath;
        }

        $('studentForm').onsubmit = async (e) => {
            e.preventDefault();
            const eid = $('editId').value, pFile = $('photoFile');
            if (!eid && !pFile.files[0]) return alert("Error: A Passport Photo is REQUIRED.");

            const fmt = (v) => {
                let s = v.replace(/[^a-zA-Z]/g, ''); 
                return s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : "";
            };

            const rawFn = $('fName').value, rawLn = $('lName').value, rawOn = $('oName').value;
            const fn = fmt(rawFn), ln = fmt(rawLn), on = fmt(rawOn);

            if (fn.length < 3) return alert("Error in First Name: Must contain at least 3 letters and no symbols/spaces.");
            if (ln.length < 3) return alert("Error in Surname: Must contain at least 3 letters and no symbols/spaces.");
            if (on.length < 3) return alert("Error in Other Names: Must contain at least 3 letters and no symbols/spaces.");

            const now = new Date();
            const ts = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0') + now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0') + now.getSeconds().toString().padStart(2, '0');
            const cid = `${fn.slice(0, 2).toUpperCase()}${on.slice(-1).toUpperCase()}${ts.split('').reverse().join('')}${ln.slice(0, 2).split('').reverse().join('').toUpperCase()}`;

            const m = parseFloat($('s_math').value)||0, p = parseFloat($('s_phys').value)||0, c = parseFloat($('s_chem').value)||0, b = parseFloat($('s_bio').value)||0, e_s = parseFloat($('s_eng').value)||0;
            const tot = (m * 0.25) + (p * 0.25) + (c * 0.25) + (b * 0.15) + (e_s * 0.10);

            const student = {
                id: eid || cid, fName: fn, lName: ln, oName: on, class: $('class').value, year: +$('year').value, position: $('pos').value,
                score: tot.toFixed(1) + "%", details: { math: m, phys: p, chem: c, bio: b, eng: e_s },
                photo: eid ? lockedPhotoPath : (await uploadFile(pFile) || 'img/default.png'),
                celebration_photo: await uploadFile($('celebFile')) || (allStudents.find(x=>x.id===eid)?.celebration_photo) || '',
                thanks: $('thanks').value.trim()
            };

            const res = await fetch('/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(student) });
            if (res.ok) { resetForm(); fetchList(); alert("Saved successfully!"); }
        };

        const toggleLock = (state) => {
            ['fName','lName','oName','class','year','pos','s_math','s_phys','s_chem','s_bio','s_eng','photoFile'].forEach(i => $(i).disabled = state);
            document.querySelectorAll('.lock-icon').forEach(i => i.style.display = state ? 'inline' : 'none');
        };

        function editRecord(id) {
            const s = allStudents.find(x => x.id === id);
            if (!s) return;
            $('editId').value = s.id; $('fName').value = s.fName; $('lName').value = s.lName; $('oName').value = s.oName || '';
            $('class').value = s.class; $('year').value = s.year; $('pos').value = s.position;
            if(s.details) {
                $('s_math').value = s.details.math; $('s_phys').value = s.details.phys; $('s_chem').value = s.details.chem;
                $('s_bio').value = s.details.bio; $('s_eng').value = s.details.eng;
            }
            $('thanks').value = s.thanks || ''; lockedPhotoPath = s.photo;
            toggleLock(true);
            $('formTitle').innerText = "Edit Profile Content"; $('submitBtn').innerText = "UPDATE CHANGES";
            $('cancelBtn').style.display = "block"; window.scrollTo(0,0);
        }

        function resetForm() {
            $('studentForm').reset(); $('editId').value = ""; lockedPhotoPath = "";
            toggleLock(false);
            $('formTitle').innerText = "Add New Recipient"; $('submitBtn').innerText = "SAVE RECIPIENT";
            $('cancelBtn').style.display = "none"; $('year').value = startY;
        }

        async function remove(id) {
            if(confirm("Delete recipient and associated photos?")) {
                const s = allStudents.find(x => x.id === id);
                await fetch('/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        id,
                        photo: s?.photo,
                        celebration_photo: s?.celebration_photo
                    })
                });
                fetchList();
            }
        }
        fetchList();
    </script>
</body>
</html>
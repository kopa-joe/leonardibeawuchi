<!DOCTYPE html>
<html>
<head>
    <title>Scholarship Admin Dashboard</title>
    <link rel="icon" type="image/png" href="img/logo.png">
    <link rel="apple-touch-icon" href="img/logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        if (sessionStorage.getItem('isAdmin') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <style>
        :root { --primary: #0b1f3a; --accent: #c9a227; --success: #27ae60; --disabled: #e9ecef; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .name-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .score-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        input:disabled, select:disabled { background-color: var(--disabled); cursor: not-allowed; }
        label { display: block; margin-top: 10px; font-weight: bold; color: #555; font-size: 0.85rem; }
        .required-star { color: #e74c3c; margin-left: 2px; }
        .lock-icon { margin-left: 5px; color: #7f8c8d; font-size: 0.8rem; display: none; }
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .save-btn { background: var(--success); color: white; border: none; padding: 15px; flex: 2; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .cancel-btn { background: #95a5a6; color: white; border: none; padding: 15px; flex: 1; border-radius: 6px; cursor: pointer; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .link-btn { background: #eee; border: 1px solid #ccc; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .qr-btn { background: var(--accent); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 5px; }
        .edit-btn { background: #3498db; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
        .del-btn { background: #e74c3c; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
        #qr-buffer { position: absolute; left: -9999px; top: -9999px; }
    </style>
</head>
<body>
    <div id="qr-buffer"></div>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 id="formTitle">Add New Recipient</h2>
            <button onclick="logout()" style="background:none; border:1px solid #ccc; padding:5px 10px; cursor:pointer; border-radius:4px;">Logout</button>
        </div>

        <form id="studentForm">
            <input type="hidden" id="editId">
            
            <div class="name-grid">
                <div><label>First Name<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label><input type="text" id="fName" required placeholder="John"></div>
                <div><label>Surname<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label><input type="text" id="lName" required placeholder="Doe"></div>
                <div><label>Other Names<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label><input type="text" id="oName" required placeholder="Michael"></div>
            </div>

            <div class="form-grid">
                <div>
                    <label>Class<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
                    <select id="class" required>
                        <option value="">Select Class</option>
                        <option value="SS1">SS1</option>
                        <option value="SS2">SS2</option>
                        <option value="SS3">SS3</option>
                    </select>
                </div>
                <div>
                    <label id="yearLabel">Year<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
                    <input type="number" id="year" max="2035" 
                           oninput="if(this.value.length > 4) this.value = this.value.slice(0, 4);" 
                           required>
                </div>
            </div>

            <div>
                <label>Position<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
                <select id="pos" required>
                    <option value="" selected disabled>Select Position</option>
                    <option value="1st Position">1st Position</option>
                    <option value="2nd Position">2nd Position</option>
                    <option value="3rd Position">3rd Position</option>
                </select>
            </div>

            <label>Subject Scores (%)<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
            <div class="score-grid">
                <div><label>Maths (25%)</label><input type="number" id="s_math" min="0" max="100" placeholder="0" required></div>
                <div><label>Phys (25%)</label><input type="number" id="s_phys" min="0" max="100" placeholder="0" required></div>
                <div><label>Chem (25%)</label><input type="number" id="s_chem" min="0" max="100" placeholder="0" required></div>
                <div><label>Bio (15%)</label><input type="number" id="s_bio" min="0" max="100" placeholder="0" required></div>
                <div><label>Eng (10%)</label><input type="number" id="s_eng" min="0" max="100" placeholder="0" required></div>
            </div>

            <label>Passport Photo<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
            <input type="file" id="photoFile" accept="image/*">
            
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            
            <label>Celebration Photo (Optional)</label>
            <input type="file" id="celebFile" accept="image/*">
            
            <label>Vote of Thanks</label>
            <textarea id="thanks" rows="4"></textarea>

            <div class="btn-row">
                <button type="submit" id="submitBtn" class="save-btn">SAVE RECIPIENT</button>
                <button type="button" id="cancelBtn" class="cancel-btn" onclick="resetForm()">CANCEL EDIT</button>
            </div>
        </form>

        <table>
            <thead>
                <tr><th>Link & Name</th><th>Year</th><th>Actions</th></tr>
            </thead>
            <tbody id="list"></tbody>
        </table>
    </div>

    <script>
        const currentYear = new Date().getFullYear();
        const startYear = currentYear - 1;
        const maxYear = 2035;
        const yearInput = document.getElementById('year');
        
        yearInput.min = startYear;
        yearInput.value = startYear;
        document.getElementById('yearLabel').innerHTML = `Year (${startYear}-${maxYear})<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span>`;

        let allStudents = [];
        let lockedPhotoPath = "";
        
        function logout() { sessionStorage.removeItem('isAdmin'); window.location.href = 'login.html'; }

        async function fetchList() {
            const res = await fetch('/data/data.json');
            allStudents = await res.json();
            document.getElementById('list').innerHTML = allStudents.map(s => `
                <tr>
                    <td>
                        <button class="link-btn" onclick="copyLink('${s.id}')">Copy Direct Link ðŸ”—</button>
                        <button class="qr-btn" onclick="generateAndDownloadQR('${s.id}')">Download QR Code ðŸ“¥</button><br>
                        <strong>${s.lName}, ${s.fName} ${s.oName}</strong>
                    </td>
                    <td>${s.year}</td>
                    <td>
                        <button class="edit-btn" onclick="editRecord('${s.id}')">Edit</button>
                        <button class="del-btn" onclick="remove('${s.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function generateAndDownloadQR(id) {
            const s = allStudents.find(x => x.id === id);
            if (!s) return;
            const buffer = document.getElementById('qr-buffer');
            buffer.innerHTML = "";
            const qr = new QRCode(buffer, {
                text: window.location.origin + '/index.html?id=' + id,
                width: 256,
                height: 256,
                colorDark: "#c9a227", 
                colorLight: "rgba(0,0,0,0)", 
                correctLevel: QRCode.CorrectLevel.H
            });
            setTimeout(() => {
                const qrCanvas = buffer.querySelector('canvas');
                const finalCanvas = document.createElement('canvas');
                const ctx = finalCanvas.getContext('2d');
                finalCanvas.width = 300;
                finalCanvas.height = 400;
                ctx.strokeStyle = "#c9a227";
                ctx.lineWidth = 5;
                ctx.strokeRect(5, 5, 290, 390);
                ctx.drawImage(qrCanvas, 22, 30, 256, 256);
                ctx.fillStyle = "#c9a227";
                ctx.textAlign = "center";
                ctx.font = "bold 16px Segoe UI";
                const fullName = `${s.fName} ${s.oName} ${s.lName}`;
                ctx.fillText(fullName.toUpperCase(), 150, 320);
                ctx.font = "14px Segoe UI";
                ctx.fillText("Scan to verify recipient details", 150, 350);
                const link = document.createElement('a');
                link.download = `${s.fName}_${s.oName}_${s.lName}_${s.year}_scholarship_qrcode.png`;
                link.href = finalCanvas.toDataURL("image/png");
                link.click();
            }, 100);
        }

        function copyLink(id) {
            const fullLink = window.location.origin + '/index.html?id=' + id;
            navigator.clipboard.writeText(fullLink);
            alert("Full link copied!");
        }

        async function uploadFile(fileInput) {
            if (!fileInput.files[0]) return null;
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            const res = await fetch('/upload', { method: 'POST', body: formData });
            const result = await res.json();
            return result.filePath;
        }

        document.getElementById('studentForm').onsubmit = async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            const photoInput = document.getElementById('photoFile');
            if (!editId && (!photoInput.files || photoInput.files.length === 0)) {
                alert("Error: A Passport Photo is REQUIRED for all new recipients.");
                return;
            }
            const formatString = (str) => {
                let s = str.trim();
                return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
            };
            const fName = formatString(document.getElementById('fName').value);
            const lName = formatString(document.getElementById('lName').value);
            const oName = document.getElementById('oName').value.trim().split(' ').map(n => formatString(n)).join(' ');
            const now = new Date();
            const fullDateStr = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0') + now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0') + now.getSeconds().toString().padStart(2, '0');
            const customId = `${fName.slice(0, 2).toUpperCase()}${oName.slice(-1).toUpperCase()}${fullDateStr.split('').reverse().join('')}${lName.slice(0, 2).split('').reverse().join('').toUpperCase()}`;

            const newPhoto = await uploadFile(photoInput);
            const newCeleb = await uploadFile(document.getElementById('celebFile'));

            // Calculate weighted score
            const m = parseFloat(document.getElementById('s_math').value) || 0;
            const p = parseFloat(document.getElementById('s_phys').value) || 0;
            const c = parseFloat(document.getElementById('s_chem').value) || 0;
            const b = parseFloat(document.getElementById('s_bio').value) || 0;
            const e_score = parseFloat(document.getElementById('s_eng').value) || 0;
            const totalPercent = (m * 0.25) + (p * 0.25) + (c * 0.25) + (b * 0.15) + (e_score * 0.10);

            const student = {
                id: editId || customId,
                fName: fName, 
                lName: lName,
                oName: oName,
                class: document.getElementById('class').value,
                year: parseInt(document.getElementById('year').value),
                position: document.getElementById('pos').value,
                score: totalPercent.toFixed(1) + "%",
                details: {
                    math: m, phys: p, chem: c, bio: b, eng: e_score
                },
                photo: editId ? lockedPhotoPath : (newPhoto || 'img/default.png'),
                celebration_photo: newCeleb || (allStudents.find(x=>x.id===editId)?.celebration_photo) || '',
                thanks: document.getElementById('thanks').value.trim()
            };

            const saveRes = await fetch('/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(student) });
            if (saveRes.ok) { resetForm(); fetchList(); alert("Saved successfully!"); }
            else { alert("Error saving record."); }
        };

        function editRecord(id) {
            const s = allStudents.find(x => x.id === id);
            if (!s) return;
            document.getElementById('editId').value = s.id;
            document.getElementById('fName').value = s.fName;
            document.getElementById('lName').value = s.lName;
            document.getElementById('oName').value = s.oName || '';
            document.getElementById('class').value = s.class;
            document.getElementById('year').value = s.year;
            document.getElementById('pos').value = s.position;
            
            if(s.details) {
                document.getElementById('s_math').value = s.details.math;
                document.getElementById('s_phys').value = s.details.phys;
                document.getElementById('s_chem').value = s.details.chem;
                document.getElementById('s_bio').value = s.details.bio;
                document.getElementById('s_eng').value = s.details.eng;
            }

            document.getElementById('thanks').value = s.thanks || '';
            lockedPhotoPath = s.photo;
            document.getElementById('photoFile').disabled = true;
            ['fName','lName','oName','class','year','pos', 's_math', 's_phys', 's_chem', 's_bio', 's_eng'].forEach(id => document.getElementById(id).disabled = true);
            document.querySelectorAll('.lock-icon').forEach(icon => icon.style.display = 'inline');
            document.getElementById('formTitle').innerText = "Edit Profile Content";
            document.getElementById('submitBtn').innerText = "UPDATE CHANGES";
            document.getElementById('cancelBtn').style.display = "block";
            window.scrollTo(0,0);
        }

        function resetForm() {
            document.getElementById('studentForm').reset();
            document.getElementById('editId').value = "";
            lockedPhotoPath = "";
            document.getElementById('photoFile').disabled = false;
            ['fName','lName','oName','class','year','pos', 's_math', 's_phys', 's_chem', 's_bio', 's_eng'].forEach(id => document.getElementById(id).disabled = false);
            document.querySelectorAll('.lock-icon').forEach(icon => icon.style.display = 'none');
            document.getElementById('formTitle').innerText = "Add New Recipient";
            document.getElementById('submitBtn').innerText = "SAVE RECIPIENT";
            document.getElementById('cancelBtn').style.display = "none";
            document.getElementById('year').value = new Date().getFullYear() - 1;
        }

        async function remove(id) { if(confirm("Delete recipient?")) { await fetch('/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})}); fetchList(); } }
        fetchList();
    </script>
</body>
</html>
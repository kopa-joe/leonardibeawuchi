<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scholarship Admin Dashboard</title>
    <link rel="icon" type="image/png" href="img/favicon.png">
    <link rel="apple-touch-icon" href="img/favicon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        if (sessionStorage.getItem('isAdmin') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <style>
        :root { --primary: #0b1f3a; --accent: #c9a227; --success: #27ae60; --disabled: #e9ecef; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .name-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .score-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; transition: all 0.3s; outline: none; }
        input:disabled, select:disabled { background-color: var(--disabled); cursor: not-allowed; border: 1px solid #ccc; }
        label { display: block; margin-top: 10px; font-weight: bold; color: #555; font-size: 0.85rem; }
        .required-star { color: var(--danger); margin-left: 2px; }
        .lock-icon { margin-left: 5px; color: #7f8c8d; font-size: 0.8rem; display: none; }
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .save-btn { background: var(--success); color: white; border: none; padding: 15px; flex: 2; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .add-btn { background: var(--primary); color: white; border: none; padding: 15px; flex: 1; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .cancel-btn { background: #95a5a6; color: white; border: none; padding: 15px; flex: 1; border-radius: 6px; cursor: pointer; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .link-btn { background: #eee; border: 1px solid #ccc; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .qr-btn { background: var(--accent); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 5px; }
        .edit-btn { background: #3498db; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
        .del-btn { background: var(--danger); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
        .input-error { border: 2px solid var(--danger) !important; border-radius: 25px !important; background-color: #fffafa; }
        .error-msg { color: var(--danger); font-size: 11px; font-weight: normal; display: block; margin-top: -2px; height: 12px; }
        #queueSection { margin-top: 30px; background: #fffdf5; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; display: none; }
        .queue-table { width: 100%; font-size: 13px; border-collapse: collapse; }
        .queue-table th { background: #c9a227; color: white; padding: 10px; }
        #qr-buffer { position: absolute; left: -9999px; top: -9999px; }

        /* Spinner Overlay Styles */
        #loaderOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10000;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        #loaderText { margin-top: 15px; font-weight: bold; color: var(--primary); font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loaderOverlay">
        <div class="spinner"></div>
        <div id="loaderText">Processing...</div>
    </div>

    <div id="qr-buffer"></div>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 id="formTitle">Add New Recipient</h2>
            <button onclick="logout()" style="background:none; border:1px solid #ccc; padding:5px 10px; cursor:pointer; border-radius:4px;">Logout</button>
        </div>

        <form id="studentForm" novalidate>
            <input type="hidden" id="editId">
            <div id="classEntrySection">
                <div class="form-grid">
                    <div>
                        <label>Class<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
                        <select id="class">
                            <option value="">Select Class</option>
                            <option value="SS1">SS1</option><option value="SS2">SS2</option><option value="SS3">SS3</option>
                        </select>
                        <span id="err_class" class="error-msg"></span>
                    </div>
                    <div>
                        <label id="yearLabel">Year<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
                        <input type="number" id="year" min="2025" max="2035">
                        <span id="err_year" class="error-msg"></span>
                    </div>
                </div>
            </div>

            <div id="userFields">
                <div class="name-grid">
                    <div><label>First Name<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label><input type="text" id="fName" placeholder="John"><span id="err_fName" class="error-msg"></span></div>
                    <div><label>Surname<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label><input type="text" id="lName" placeholder="Doe"><span id="err_lName" class="error-msg"></span></div>
                    <div><label>Other Names<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label><input type="text" id="oName" placeholder="Michael"><span id="err_oName" class="error-msg"></span></div>
                </div>

                <div id="posContainer" style="display:none;">
                    <label>Position<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
                    <select id="pos">
                        <option value="" selected disabled>Select Position</option>
                        <option value="1st Position">1st Position</option>
                        <option value="2nd Position">2nd Position</option>
                        <option value="3rd Position">3rd Position</option>
                    </select>
                </div>

                <label>Subject Scores (%)<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
                <div class="score-grid">
                    <div><label>Maths (25%)</label><input type="number" id="s_math" placeholder="0"><span id="err_s_math" class="error-msg"></span></div>
                    <div><label>Phys (25%)</label><input type="number" id="s_phys" placeholder="0"><span id="err_s_phys" class="error-msg"></span></div>
                    <div><label>Chem (25%)</label><input type="number" id="s_chem" placeholder="0"><span id="err_s_chem" class="error-msg"></span></div>
                    <div><label>Bio (15%)</label><input type="number" id="s_bio" placeholder="0"><span id="err_s_bio" class="error-msg"></span></div>
                    <div><label>Eng (10%)</label><input type="number" id="s_eng" placeholder="0"><span id="err_s_eng" class="error-msg"></span></div>
                </div>

                <label>Passport Photo<span class="required-star">*</span><span class="lock-icon">ðŸ”’</span></label>
                <input type="file" id="photoFile" accept="image/*">
                <span id="err_photoFile" class="error-msg"></span>
                <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                <label>Celebration Photo (Optional)</label>
                <input type="file" id="celebFile" accept="image/*">
                <label>Vote of Thanks</label>
                <textarea id="thanks" rows="4"></textarea>
            </div>

            <div class="btn-row">
                <button type="button" id="addNextBtn" class="add-btn" onclick="addToQueue()">ADD ANOTHER USER</button>
                <button type="submit" id="submitBtn" class="save-btn">SAVE USERS</button>
                <button type="button" id="cancelBtn" class="cancel-btn" onclick="resetForm()">CANCEL EDIT</button>
            </div>
        </form>

        <div id="queueSection">
            <h3>Pending Queue List</h3>
            <table class="queue-table">
                <thead><tr><th>Name</th><th>Score</th><th>Potential Position</th><th>Action</th></tr></thead>
                <tbody id="queueList"></tbody>
            </table>
        </div>

        <table>
            <thead><tr><th>Link & Name</th><th>Year</th><th>Actions</th></tr></thead>
            <tbody id="list"></tbody>
        </table>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        const startY = new Date().getFullYear() - 1;
        let allStudents = [], lockedPhotoPath = "", pendingQueue = [];
        
        $('year').value = Math.max(2025, startY);

        const showLoader = (text) => { $('loaderText').innerText = text; $('loaderOverlay').style.display = 'flex'; };
        const hideLoader = () => { $('loaderOverlay').style.display = 'none'; };

        const logout = () => { sessionStorage.removeItem('isAdmin'); window.location.href = 'login.html'; };

        async function fetchList() {
            const res = await fetch('/data/data.json');
            allStudents = await res.json();
            $('list').innerHTML = allStudents.map(s => `
                <tr>
                    <td>
                        <button class="link-btn" onclick="copyLink('${s.id}')">Copy Direct Link ðŸ”—</button>
                        <button class="qr-btn" onclick="generateAndDownloadQR('${s.id}')">Download QR Code ðŸ“¥</button><br>
                        <strong>${s.lName}, ${s.fName} ${s.oName}</strong>
                    </td>
                    <td>${s.year}</td>
                    <td>
                        <button class="edit-btn" onclick="editRecord('${s.id}')">Edit</button>
                        <button class="del-btn" onclick="remove('${s.id}')">Delete</button>
                    </td>
                </tr>`).join('');
        }

        function copyLink(id) {
            const url = window.location.origin + '/index.html?id=' + id;
            navigator.clipboard.writeText(url).then(() => alert("Direct link copied to clipboard!"));
        }

        const validate = () => {
            let valid = true;
            let firstErr = null;
            const check = (id, msg, cond) => {
                const el = $(id);
                const err = $('err_' + id);
                if (cond) {
                    el.classList.add('input-error');
                    if(err) err.innerText = msg;
                    if(!firstErr) firstErr = el;
                    valid = false;
                } else {
                    el.classList.remove('input-error');
                    if(err) err.innerText = "";
                }
            };

            const alphaOnly = /^[A-Za-z]{3,}$/;
            check('class', "Selection required", !$('class').value);
            check('year', "Min 2025, Max 2035", !$('year').value || $('year').value < 2025 || $('year').value > 2035);
            check('fName', "Min 3 alphabets only", !alphaOnly.test($('fName').value.trim()));
            check('lName', "Min 3 alphabets only", !alphaOnly.test($('lName').value.trim()));
            check('oName', "Min 3 alphabets only", !alphaOnly.test($('oName').value.trim()));
            ['s_math','s_phys','s_chem','s_bio','s_eng'].forEach(s => {
                const val = $(s).value;
                check(s, "0-100", val === "" || val < 0 || val > 100);
            });
            if (!$('editId').value) check('photoFile', "Required", !$('photoFile').files[0]);
            
            if(firstErr) firstErr.focus();
            return valid;
        };

        const fmt = v => {
            let s = v.replace(/[^a-zA-Z]/g, ''); 
            return s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : "";
        };

        function getPrioritySortedQueue(arr) {
            return [...arr].sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                if (b.scores.m !== a.scores.m) return b.scores.m - a.scores.m;
                if (b.scores.p !== a.scores.p) return b.scores.p - a.scores.p;
                if (b.scores.c !== a.scores.c) return b.scores.c - a.scores.c;
                if (b.scores.b !== a.scores.b) return b.scores.b - a.scores.b;
                return b.scores.e - a.scores.e;
            });
        }

        function addToQueue() {
            if (!validate()) return false;
            const m = parseFloat($('s_math').value), p = parseFloat($('s_phys').value), c = parseFloat($('s_chem').value), b = parseFloat($('s_bio').value), e = parseFloat($('s_eng').value);
            const total = (m * 0.25) + (p * 0.25) + (c * 0.25) + (b * 0.15) + (e * 0.10);

            if (total < 75) {
                alert("User score less than 75% threshold. Profile will not be added.");
                return false;
            }

            pendingQueue.push({
                fName: fmt($('fName').value), lName: fmt($('lName').value), oName: fmt($('oName').value),
                scores: { m, p, c, b, e }, score: total,
                photo: $('photoFile').files[0], celeb: $('celebFile').files[0],
                thanks: $('thanks').value.trim()
            });

            $('class').disabled = true; $('year').disabled = true;
            renderQueue();
            ['fName','lName','oName','s_math','s_phys','s_chem','s_bio','s_eng','photoFile','celebFile','thanks'].forEach(i => $(i).value = "");
            return true;
        }

        function renderQueue() {
            if (!pendingQueue.length) { $('queueSection').style.display = 'none'; return; }
            $('queueSection').style.display = 'block';
            const sorted = getPrioritySortedQueue(pendingQueue);
            const posLabel = ["1st", "2nd", "3rd"];
            
            $('queueList').innerHTML = pendingQueue.map((u) => {
                const itemIdxInSorted = sorted.indexOf(u);
                let displayPos = "";
                if (itemIdxInSorted === 0) {
                    displayPos = posLabel[0];
                } else if (itemIdxInSorted < 3) {
                    const prev = sorted[itemIdxInSorted - 1];
                    const isAllSubjectTie = (u.score === prev.score && u.scores.m === prev.scores.m && u.scores.p === prev.scores.p && u.scores.c === prev.scores.c && u.scores.b === prev.scores.b && u.scores.e === prev.scores.e);
                    if (isAllSubjectTie) {
                        let firstTieIdx = itemIdxInSorted;
                        while(firstTieIdx > 0) {
                            const current = sorted[firstTieIdx];
                            const comparative = sorted[firstTieIdx - 1];
                            const tieCheck = (current.score === comparative.score && current.scores.m === comparative.scores.m && current.scores.p === comparative.scores.p && current.scores.c === comparative.scores.c && current.scores.b === comparative.scores.b && current.scores.e === comparative.scores.e);
                            if (tieCheck) firstTieIdx--;
                            else break;
                        }
                        displayPos = posLabel[firstTieIdx];
                    } else {
                        displayPos = posLabel[itemIdxInSorted];
                    }
                } else {
                    displayPos = "Discarded (Not Top 3)";
                }
                const idx = pendingQueue.indexOf(u);
                return `<tr><td>${u.fName} ${u.lName}</td><td>${u.score.toFixed(1)}%</td><td><strong>${displayPos}</strong></td><td><button class="del-btn" onclick="pendingQueue.splice(${idx},1);renderQueue()">Remove</button></td></tr>`;
            }).join('');
        }

        $('studentForm').onsubmit = async (e) => {
            e.preventDefault();
            const eid = $('editId').value;

            if (eid) {
                if (!validate()) return;
                showLoader("Updating profile...");
                const m = parseFloat($('s_math').value), p = parseFloat($('s_phys').value), c = parseFloat($('s_chem').value), b = parseFloat($('s_bio').value), e = parseFloat($('s_eng').value);
                const total = (m * 0.25) + (p * 0.25) + (c * 0.25) + (b * 0.15) + (e * 0.10);
                
                showLoader("Uploading celebration photo...");
                const student = {
                    id: eid, fName: fmt($('fName').value), lName: fmt($('lName').value), oName: fmt($('oName').value),
                    class: $('class').value, year: +$('year').value, position: $('pos').value,
                    score: total.toFixed(1) + "%", details: { math: m, phys: p, chem: c, bio: b, eng: e },
                    photo: lockedPhotoPath,
                    celebration_photo: ($('celebFile').files[0] ? await uploadRawFile($('celebFile').files[0]) : (allStudents.find(x=>x.id===eid)?.celebration_photo) || ''),
                    thanks: $('thanks').value.trim()
                };
                showLoader("Saving changes...");
                await fetch('/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(student) });
                hideLoader();
                alert("Profile Updated Successfully!");
                resetForm();
                return;
            }

            if ($('fName').value.trim() !== "") {
                const added = addToQueue();
                if (!added) return; 
            }

            if (pendingQueue.length === 0) {
                alert("The queue is empty. Please add users first.");
                return;
            }

            showLoader("Calculating final rankings...");
            const sorted = getPrioritySortedQueue(pendingQueue);
            const posNames = ["1st Position", "2nd Position", "3rd Position"];
            let savedCount = 0;

            for (let i = 0; i < sorted.length; i++) {
                const u = sorted[i];
                let assignedPos = "";
                if (i === 0) {
                    assignedPos = posNames[0];
                } else if (i < 3) {
                    const prev = sorted[i - 1];
                    const isAbsoluteTie = (u.score === prev.score && u.scores.m === prev.scores.m && u.scores.p === prev.scores.p && u.scores.c === prev.scores.c && u.scores.b === prev.scores.b && u.scores.e === prev.scores.e);
                    if (isAbsoluteTie) {
                        assignedPos = prev.assignedPos;
                    } else {
                        assignedPos = posNames[i];
                    }
                }

                if (assignedPos) {
                    showLoader(`Saving ${u.fName} (${assignedPos})...`);
                    const now = new Date();
                    const pad = (n) => n.toString().padStart(2, '0');
                    const dtStr = now.getFullYear().toString() + pad(now.getMonth()+1) + pad(now.getDate()) + pad(now.getHours()) + pad(now.getMinutes()) + pad(now.getSeconds());
                    const dtRev = dtStr.split('').reverse().join('');
                    const cid = `${u.fName.slice(0,2).toUpperCase()}${dtRev}${u.lName.charAt(0).toUpperCase()}`;

                    const student = {
                        id: cid, fName: u.fName, lName: u.lName, oName: u.oName,
                        class: $('class').value, year: +$('year').value, position: assignedPos,
                        score: u.score.toFixed(1) + "%", 
                        details: { math: u.scores.m, phys: u.scores.p, chem: u.scores.c, bio: u.scores.b, eng: u.scores.e },
                        photo: await uploadRawFile(u.photo) || 'img/default.png',
                        celebration_photo: await uploadRawFile(u.celeb) || '',
                        thanks: u.thanks
                    };

                    await fetch('/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(student) });
                    savedCount++;
                }
            }

            hideLoader();
            alert(`Batch Complete: ${savedCount} users successfully saved based on ranking.`);
            resetForm();
        };

        async function uploadRawFile(file) {
            if (!file) return null;
            const fd = new FormData(); fd.append('image', file);
            const res = await fetch('/upload', { method: 'POST', body: fd });
            const data = await res.json();
            return data.filePath;
        }

        function editRecord(id) {
            const s = allStudents.find(x => x.id === id);
            if (!s) return;
            resetForm();
            $('editId').value = s.id; $('fName').value = s.fName; $('lName').value = s.lName; $('oName').value = s.oName || '';
            $('class').value = s.class; $('year').value = s.year;
            if(s.details) {
                $('s_math').value = s.details.math; $('s_phys').value = s.details.phys; $('s_chem').value = s.details.chem;
                $('s_bio').value = s.details.bio; $('s_eng').value = s.details.eng;
            }
            $('thanks').value = s.thanks || ''; lockedPhotoPath = s.photo;
            toggleLock(true);
            $('posContainer').style.display = 'block'; $('pos').value = s.position;
            $('addNextBtn').style.display = 'none';
            $('formTitle').innerText = "Edit Profile"; $('submitBtn').innerText = "UPDATE";
            $('cancelBtn').style.display = "block"; window.scrollTo(0,0);
        }

        const toggleLock = (state) => {
            ['fName','lName','oName','class','year','pos','s_math','s_phys','s_chem','s_bio','s_eng','photoFile'].forEach(i => $(i).disabled = state);
            document.querySelectorAll('.lock-icon').forEach(i => i.style.display = state ? 'inline' : 'none');
        };

        function resetForm() {
            $('studentForm').reset(); $('editId').value = ""; lockedPhotoPath = ""; pendingQueue = [];
            toggleLock(false); renderQueue();
            $('posContainer').style.display = 'none'; $('addNextBtn').style.display = 'block';
            $('formTitle').innerText = "Add New Recipient"; $('submitBtn').innerText = "SAVE USERS";
            $('cancelBtn').style.display = "none"; $('year').value = Math.max(2025, startY); fetchList();
        }

        async function remove(id) { 
            if(confirm("Delete recipient and photos?")) { 
                const s = allStudents.find(x => x.id === id);
                if(!s) return;
                showLoader("Deleting record...");
                await fetch('/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ id, photo: s.photo, celebration_photo: s.celebration_photo }) }); 
                hideLoader();
                fetchList(); 
            } 
        }

        async function generateAndDownloadQR(id) {
            const s = allStudents.find(x => x.id === id);
            if (!s) return;
            const buf = $('qr-buffer'); buf.innerHTML = "";
            new QRCode(buf, { 
                text: window.location.origin + '/index.html?id=' + id, 
                width: 256, height: 256, 
                colorDark: "#c9a227", colorLight: "rgba(0,0,0,0)",
                correctLevel: QRCode.CorrectLevel.H
            });

            setTimeout(() => {
                const cv = document.createElement('canvas'), ctx = cv.getContext('2d'), qr = buf.querySelector('canvas');
                cv.width = 300; cv.height = 420;
                ctx.strokeStyle = "#c9a227"; ctx.lineWidth = 3; ctx.strokeRect(5, 5, 290, 410);
                ctx.drawImage(qr, 22, 20, 256, 256);
                ctx.fillStyle = "#c9a227"; ctx.textAlign = "center";
                ctx.font = "bold 16px Segoe UI";
                const fullName = `${s.fName} ${s.oName} ${s.lName}`.toUpperCase();
                const maxWidth = 260; 
                const words = fullName.split(' ');
                let line = '';
                let y = 310;
                const lineHeight = 20;
                for (let n = 0; n < words.length; n++) {
                    let testLine = line + words[n] + ' ';
                    let metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && n > 0) {
                        ctx.fillText(line.trim(), 150, y);
                        line = words[n] + ' ';
                        y += lineHeight;
                    } else { line = testLine; }
                }
                ctx.fillText(line.trim(), 150, y);
                ctx.font = "14px Segoe UI"; 
                ctx.fillText("Scan to verify recipient details", 150, y + 30);
                const a = document.createElement('a'); 
                a.download = `${s.fName}_${s.oName}_${s.lName}_${s.year}_scholarship_qrcode.png`; 
                a.href = cv.toDataURL("image/png"); 
                a.click();
            }, 200);
        }

        fetchList();
    </script>
</body>
</html>